{% set resource_prefix = company_slug + "-" + environment %}

# Company-specific Terraform configuration
# Generated for: {{ company_name }}
# Company Slug: {{ company_slug }}
# Environment: {{ environment }}
# Generated at: {{ timestamp }}

terraform {
  required_version = ">= 1.0"
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.0"
    }
  }
  
  backend "azurerm" {
    resource_group_name  = "{{ terraform_state_rg }}"
    storage_account_name = "{{ terraform_state_storage }}"
    container_name       = "tfstate"
    key                  = "companies/{{ company_slug }}/terraform.tfstate"
  }
}

provider "azurerm" {
  features {}
  
  subscription_id = "{{ azure_subscription_id }}"
  tenant_id      = "{{ azure_tenant_id }}"
  client_id      = "{{ azure_client_id }}"
  client_secret  = "{{ azure_client_secret }}"
}

# Variables
variable "company_name" {
  description = "Company name"
  type        = string
  default     = "{{ company_name }}"
}

variable "company_slug" {
  description = "Company slug"
  type        = string
  default     = "{{ company_slug }}"
}

variable "environment" {
  description = "Environment"
  type        = string
  default     = "{{ environment }}"
}

variable "azure_region" {
  description = "Azure region"
  type        = string
  default     = "{{ azure_region }}"
}

variable "vnet_cidr" {
  description = "VNet CIDR"
  type        = string
  default     = "{{ vnet_cidr }}"
}

variable "public_subnet_cidr" {
  description = "Public subnet CIDR"
  type        = string
  default     = "{{ public_subnet_cidr }}"
}

variable "private_subnet_cidr" {
  description = "Private subnet CIDR"
  type        = string
  default     = "{{ private_subnet_cidr }}"
}

variable "db_admin_username" {
  description = "Database admin username"
  type        = string
  default     = "{{ db_admin_username }}"
}

variable "api_container_image" {
  description = "API container image"
  type        = string
  default     = "{{ api_container_image }}"
}

variable "web_container_image" {
  description = "Web container image"
  type        = string
  default     = "{{ web_container_image }}"
}

# Include the main module
module "company_infrastructure" {
  source = "../../"
  
  company_name         = var.company_name
  company_slug         = var.company_slug
  environment          = var.environment
  azure_region         = var.azure_region
  vnet_cidr           = var.vnet_cidr
  public_subnet_cidr  = var.public_subnet_cidr
  private_subnet_cidr = var.private_subnet_cidr
  db_admin_username   = var.db_admin_username
  api_container_image = var.api_container_image
  web_container_image = var.web_container_image
}

# Outputs
output "company_infrastructure" {
  description = "All infrastructure outputs"
  value = {
    resource_group_name    = module.company_infrastructure.resource_group_name
    resource_group_id      = module.company_infrastructure.resource_group_id
    vnet_id               = module.company_infrastructure.vnet_id
    public_subnet_id      = module.company_infrastructure.public_subnet_id
    private_subnet_id     = module.company_infrastructure.private_subnet_id
    database_fqdn         = module.company_infrastructure.database_fqdn
    database_name         = module.company_infrastructure.database_name
    storage_account_name  = module.company_infrastructure.storage_account_name
    blob_storage_url      = module.company_infrastructure.blob_storage_url
    ai_services_endpoint  = module.company_infrastructure.ai_services_endpoint
    api_app_url          = module.company_infrastructure.api_app_url
    web_app_url          = module.company_infrastructure.web_app_url
    cdn_endpoint_url     = module.company_infrastructure.cdn_endpoint_url
    key_vault_id         = module.company_infrastructure.key_vault_id
  }
  sensitive = true
}